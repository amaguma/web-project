<!DOCTYPE html>
<html>
	<head><meta charset="UTF-8"></head>
	<body>
		<p id="userdata">Вы вошли как </p>
		<button id="exit">Выйти</button><br>

		<table id="dialogOl"></table>		

		<table id="chatTable"></table>
		<textarea id="messageText"></textarea>
		<button id="submit">Отправить</button>
		<div id="state"></div>
		<div id="rcode"></div>
		<script src="/socket.io/socket.io.js"></script>
		<script>
			const req = new XMLHttpRequest()
			
			req.open('GET', '/req/curuser.js', true)
			req.onreadystatechange = () => {
				if (req.readyState != 4) return;
				const curUser = JSON.parse(req.responseText).user
				userdata.textContent += curUser
	  			const socket = io()
	  			socket.on('message', (data) => {
	  				chatTable.innerHTML += "<tr><td>" + data.user + '</td><td>' + data.message + '</td></tr>';
	  			})
	  			
	  			submit.onclick = () => {
	  				socket.emit('message', {message: messageText.value})
	  				chatTable.innerHTML += "<tr><td>" + curUser + '</td><td>' + messageText.value + '</td></tr>';
	  				messageText.value = ''
	  			}
			}
			req.send()

			const dialogList = new XMLHttpRequest()

			dialogList.open('GET','/req/dialogList.js',true) 
			dialogList.onreadystatechange = () => {
				
				if (dialogList.readyState != 4) return;
				const curUser = JSON.parse(dialogList.responseText).user
				userdata.textContent += curUser

				const socket = io()
				socket.on('dialogListClient', (data) => {
					document.getElementById("dialogOl").innerHTML = "<tr><td>" + Object.keys(data).length + '</td><td>'
					Object.keys(data).forEach(element => document.getElementById("dialogOl").innerHTML+= "<tr><td>" +"id " + element + '</td><td>')
				})
				  
				socket.emit('dialogListServer')
			}
			dialogList.send()


			exit.onclick = () => {
				const ereq = new XMLHttpRequest()
				ereq.open('GET', '/req/exit.js', true)
				ereq.onreadystatechange = () => {
					if (ereq.readyState != 4) return;
					
					state.textContent = ereq.status
					rcode.textContent = ereq.responseText
				}
				ereq.send()
			}
		</script>
	</body>
</html>